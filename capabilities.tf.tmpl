{{ range . -}}
provider "ns" {
  capability_id = {{ .Id }}
  alias         = "cap_{{ .Id }}"
}

module "{{ .TfModuleName }}" {
  source  = "{{ .Source }}/any"
  {{ if (ne .SourceVersion "latest") }}version = "{{ .SourceVersion }}"{{ end }}

  app_metadata = {
    security_group_id  = aws_security_group.this.id
    main_container     = local.main_container_name
    service_port       = var.service_port
    log_group_name     = module.logs.name
    internal_subdomain = var.service_port == 0 ? "" : "${local.block_name}.${local.service_domain}"
    role_name          = aws_iam_role.task.name
  }

  {{- range $key, $value := .Variables }}
  {{ if not $value.Unused -}}
  {{ $key }} = jsondecode({{ $value.Value | to_json_string }})
  {{- end }}{{ end }}

  providers = {
    ns = ns.cap_{{ .Id}}
  }
}
{{ end }}
module "caps" {
  source  = "nullstone-modules/cap-merge/ns"
  modules = local.modules
}

locals {
  modules       = [
{{- range $index, $element := .ExceptNeedsDestroyed.TfModuleAddrs -}}
{{ if $index }}, {{ end }}{{ $element }}
{{- end -}}
]
  capabilities  = module.caps.outputs
}
